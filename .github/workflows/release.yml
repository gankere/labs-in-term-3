name: C++ CI

on:
  push:
    branches: [ 'lab4' ]

permissions:
  contents: write

jobs:
  bump_version:
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.bump.outputs.new_tag }}
      major: ${{ steps.bump.outputs.major }}
      minor: ${{ steps.bump_version.outputs.minor }}
      patch: ${{ steps.bump_version.outputs.patch }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump version
        id: bump
        shell: bash
        run: |
          git fetch --tags --quiet
          # Получаем последний тег, начинающийся с v или без v, но в формате X.Y.Z
          last_tag=$(git tag --sort=-v:refname | grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+$' | head -n1)
          if [ -z "$last_tag" ]; then
            last_tag="0.0.0"
          else
            last_tag=${last_tag#v}  # убираем v, если есть
          fi

          IFS='.' read -r major minor patch <<< "$last_tag"

          while true; do
            patch=$((patch+1))
            new_tag="$major.$minor.$patch"

            if git rev-parse -q --verify "refs/tags/$new_tag" >/dev/null 2>&1; then
              continue
            fi
            if git ls-remote --tags origin "refs/tags/$new_tag" | grep -q "$new_tag"; then
              continue
            fi

            git tag "$new_tag"
            git push origin "refs/tags/$new_tag"
            echo "new_tag=$new_tag" >> "$GITHUB_OUTPUT"
            echo "major=$major" >> "$GITHUB_OUTPUT"
            echo "minor=$minor" >> "$GITHUB_OUTPUT"
            echo "patch=$patch" >> "$GITHUB_OUTPUT"
            break
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build_and_package:
    needs: bump_version
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    
    steps:
      - uses: actions/checkout@v4

      - name: Clean build directory
        run: |
          if [ -d "build" ]; then
            echo "Removing existing build directory..."
            rm -rf build
          fi
        shell: bash

      - name: Install dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++

      - name: Install dependencies (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          choco install cmake -y
        shell: pwsh

      - name: Configure CMake
        shell: bash
        run: |
          cmake -B build \
            -DPROJECT_VERSION_MAJOR=${{ needs.bump_version.outputs.major }} \
            -DPROJECT_VERSION_MINOR=${{ needs.bump_version.outputs.minor }} \
            -DPATCH_VERSION=${{ needs.bump_version.outputs.patch }}

      - name: Build
        shell: bash
        run: cmake --build build

      - name: Debug build info
        shell: bash
        run: |
          echo "=== Build structure ==="
          find ./build -type f -name "*.exe" -o -name "lab4" | head -20
          echo "=== File sizes ==="
          find ./build -type f \( -name "*.exe" -o -name "lab4" \) -exec ls -la {} \; | head -10

      - name: Run with debug output (Linux)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          if [ -f "./build/lab4" ]; then
            echo "=== Running on Linux ==="
            ./build/lab4
          else
            echo "ERROR: Linux executable not found"
            exit 1
          fi

      - name: Run with debug output (Windows)
        if: matrix.os == 'windows-latest'
        shell: cmd
        run: |
          echo "=== Running on Windows ==="
          build\Debug\lab4.exe
        continue-on-error: true

      - name: Run with GDB debug (Linux)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          if command -v gdb >/dev/null 2>&1; then
            if [ -f "./build/lab4" ]; then
              echo "=== Running with GDB ==="
              gdb -ex "run" -ex "bt" -ex "quit" --args ./build/lab4
            fi
          else
            echo "GDB not available"
          fi
        continue-on-error: true

      - name: Create Release
        if: matrix.os == 'ubuntu-latest'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.bump_version.outputs.new_tag }}
          files: |
            build/lab4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}