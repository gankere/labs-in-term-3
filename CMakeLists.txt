cmake_minimum_required(VERSION 3.10.0)

# –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
if(NOT DEFINED PROJECT_VERSION_MAJOR)
  set(PROJECT_VERSION_MAJOR 0)
endif()
if(NOT DEFINED PROJECT_VERSION_MINOR)
  set(PROJECT_VERSION_MINOR 0)
endif()
if(NOT DEFINED PATCH_VERSION)
  set(PATCH_VERSION 0)
endif()

set(PROJECT_VERSION_PATCH ${PATCH_VERSION})

project(lab2 VERSION ${PROJECT_VERSION_MAJOR}.${PROJECT_VERSION_MINOR}.${PROJECT_VERSION_PATCH} LANGUAGES C CXX)

# –û—Å–Ω–æ–≤–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
add_library(functions STATIC functions.cpp)
target_include_directories(functions PUBLIC "${CMAKE_CURRENT_SOURCE_DIR}")
add_library(lab2::functions ALIAS functions)

# –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª
add_executable(lab2 main.cpp)
target_link_libraries(lab2 PRIVATE functions)

# üëá –¢–µ–ø–µ—Ä—å lab2 —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å include –∏ compile definitions
configure_file(version.h.in version.h @ONLY)
target_include_directories(lab2 PRIVATE "${CMAKE_BINARY_DIR}")

# –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –¥–∞–Ω–Ω—ã—Ö
target_compile_definitions(lab2 PRIVATE 
    IP_FILTER_PATH="${CMAKE_SOURCE_DIR}/ip_filter.tsv"
)

# –¢–µ—Å—Ç—ã
add_subdirectory(gtest_tests)

# CPack ‚Äî —É–ø–∞–∫–æ–≤–∫–∞ –≤ .zip / .deb
set(CPACK_PACKAGE_NAME "Lab2")
set(CPACK_PACKAGE_VERSION "${PROJECT_VERSION_MAJOR}.${PROJECT_VERSION_MINOR}.${PROJECT_VERSION_PATCH}")
set(CPACK_PACKAGE_FILE_NAME "${CPACK_PACKAGE_NAME}-${CPACK_PACKAGE_VERSION}-${CMAKE_SYSTEM_NAME}")
set(CPACK_OUTPUT_FILE_PREFIX "${CMAKE_BINARY_DIR}/package")

if(WIN32)
  set(CPACK_GENERATOR "ZIP")
elseif(UNIX)
  set(CPACK_GENERATOR "DEB")
  set(CPACK_DEBIAN_PACKAGE_MAINTAINER "avv100 <avv100@tpu.ru>")
endif()

install(TARGETS lab2 DESTINATION bin)

include(CPack)